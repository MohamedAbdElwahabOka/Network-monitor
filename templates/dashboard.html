
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor V18.0 Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0d1117; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #161b22; border: 1px solid #30363d; margin-bottom: 15px; border-radius: 10px; }
        .stat-box { background: #1c2128; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #30363d; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #58a6ff; }
        .stat-label { font-size: 0.9rem; color: #8b949e; }
        .device-name { color: #58a6ff; font-weight: bold; font-size: 1.1rem; }
        .vendor-badge { font-size: 0.75rem; background: #21262d; padding: 2px 8px; border-radius: 4px; color: #f78166; margin-left: 5px; }
        .speed-indicator { font-weight: bold; }
        .speed-high { color: #f85149; }
        .speed-medium { color: #d29922; }
        .speed-low { color: #3fb950; }
        
        .app-row { font-size: 0.85rem; padding: 4px 0; display: flex; justify-content: space-between; color: #c9d1d9; }
        .usage-text { color: #8b949e; }
        .device-meta { color: #8b949e; font-size: 0.85rem; margin-bottom: 10px; }
        .device-meta i { color: #58a6ff; width: 20px; text-align: center; }
        .progress { height: 6px; background-color: #21262d; border-radius: 3px; }
        .progress-bar { background: linear-gradient(90deg, #58a6ff 0%, #1f6feb 100%); }
        .ip-changed { color: #f85149; font-size: 0.8rem; animation: blink 2s infinite; }
        .sort-timer { font-size: 0.8rem; color: #6e7681; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .btn-details { 
            background: #238636; 
            border: none; 
            color: white; 
            padding: 4px 12px; 
            border-radius: 6px; 
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-details:hover { background: #2ea043; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
                 overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { 
            background-color: #161b22; 
            margin: 5% auto; 
            padding: 20px; 
            border: 1px solid #30363d; 
            border-radius: 10px;
            width: 90%; 
            max-width: 900px; 
            color: #c9d1d9;
        }
        .close { color: #8b949e; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #f85149; }
        
        .site-entry { 
            background: #21262d; 
            padding: 8px 12px; 
            margin: 5px 0; 
            border-radius: 6px; 
            display: flex; 
            justify-content: space-between;
            border-left: 3px solid #58a6ff;
        }
        .domain-name { color: #58a6ff; font-weight: 500; }
        .visit-count { color: #8b949e; font-size: 0.85rem; }
        .timestamp { color: #6e7681; font-size: 0.75rem; }
        
        .tabs { display: flex; border-bottom: 2px solid #21262d; margin-bottom: 20px; }
        .tab { 
            padding: 10px 20px; 
            cursor: pointer; 
            color: #8b949e; 
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .mini-stat { background: #21262d; padding: 10px; border-radius: 6px; text-align: center; }
        .mini-stat-value { font-size: 1.2rem; color: #58a6ff; font-weight: bold; }
        .mini-stat-label { font-size: 0.8rem; color: #8b949e; }
        
        /* Content Type Icons & Colors */
        .content-type-box { 
            background: #21262d; 
            padding: 8px; 
            border-radius: 6px; 
            margin: 3px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid;
        }
        .ct-images { border-left-color: #f85149; }
        .ct-videos { border-left-color: #d29922; }
        .ct-streaming { border-left-color: #a371f7; }
        .ct-audio { border-left-color: #3fb950; }
        .ct-text { border-left-color: #58a6ff; }
        .ct-documents { border-left-color: #f78166; }
        .ct-downloads { border-left-color: #79c0ff; }
        .ct-other { border-left-color: #6e7681; }
        
        .content-icon { font-size: 1.2rem; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row mb-4">
            <div class="col-md-3"><div class="stat-box"><div class="stat-val" id="wan-total">0 MB</div><div class="stat-label">üåê WAN (Internet)</div></div></div>
            <div class="col-md-3"><div class="stat-box"><div class="stat-val text-warning" id="clients-net">0 MB</div><div class="stat-label">üî• Clients (Net)</div></div></div>
            <div class="col-md-3"><div class="stat-box"><div class="stat-val text-info" id="clients-loc">0 MB</div><div class="stat-label">üè† Local (LAN)</div></div></div>
            <div class="col-md-3"><div class="stat-box"><div class="stat-val" id="host-total">0 MB</div><div class="stat-label">üíª Laptop (Host)</div></div></div>
        </div>
        
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <span class="text-muted"><i class="fas fa-clock"></i> Runtime: <span id="session-time">00:00:00</span></span>
            <span class="sort-timer"><i class="fas fa-sort-amount-down"></i> Next Reorder: <span id="sort-countdown">15:00</span></span>
            <span class="text-success" id="connection-status">‚óè Live</span>
        </div>

        <div class="row" id="devices-container"></div>
    </div>

    <!-- Modal ŸÑŸÑÿ™ŸÅÿßÿµŸäŸÑ -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modal-title" style="color: #58a6ff; margin-bottom: 20px;"></h3>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('top-sites')">üî• Most Visited</div>
                <div class="tab" onclick="switchTab('recent')">üïê Recent Activity</div>
                <div class="tab" onclick="switchTab('stats')">üìä Statistics</div>
            </div>
            
            <div id="top-sites" class="tab-content active"></div>
            <div id="recent" class="tab-content"></div>
            <div id="stats" class="tab-content"></div>
        </div>
    </div>

    <script>
        let cachedOrder = [];
        let nextSortTime = 0;
        const SORT_INTERVAL_MS = 15 * 60 * 1000;

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bps) {
            if (bps < 1024) return bps.toFixed(0) + ' B/s';
            if (bps < 1024*1024) return (bps/1024).toFixed(1) + ' KB/s';
            return (bps/(1024*1024)).toFixed(2) + ' MB/s';
        }

        function getSpeedClass(bps) {
            if (bps > 1024*1024) return 'speed-high';
            if (bps > 100*1024) return 'speed-medium';
            return 'speed-low';
        }

        function formatTimeLeft(ms) {
            if (ms < 0) return "00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function formatTimestamp(ts) {
            const date = new Date(ts * 1000);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function showDeviceDetails(mac) {
            try {
                const response = await fetch(`/device/${mac}/history`);
                const data = await response.json();
                
                document.getElementById('modal-title').innerText = `üì± ${data.device.name} (${data.device.ip})`;
                
                // Top Sites
                let topHtml = '<h5 style="color: #58a6ff; margin-bottom: 15px;">Most Visited Websites</h5>';
                data.top_sites.slice(0, 20).forEach(site => {
                    topHtml += `
                        <div class="site-entry">
                            <span class="domain-name">${site.domain}</span>
                            <span class="visit-count">${site.visits} visits ‚Ä¢ ${formatBytes(site.usage)}</span>
                        </div>
                    `;
                });
                document.getElementById('top-sites').innerHTML = topHtml || '<p style="color: #6e7681;">No data available</p>';
                
                // Recent
                let recentHtml = '<h5 style="color: #58a6ff; margin-bottom: 15px;">Recent Activity (Last 50)</h5>';
                data.recent_sites.slice().reverse().forEach(site => {
                    recentHtml += `
                        <div class="site-entry">
                            <div>
                                <span class="domain-name">${site.domain}</span>
                                <div class="timestamp">${formatTimestamp(site.timestamp)}</div>
                            </div>
                            <span class="visit-count">${site.category}</span>
                        </div>
                    `;
                });
                document.getElementById('recent').innerHTML = recentHtml || '<p style="color: #6e7681;">No recent activity</p>';
                
                // Stats
                let statsHtml = '<h5 style="color: #58a6ff; margin-bottom: 15px;">Device Statistics</h5>';
                statsHtml += '<div class="stats-grid">';
                statsHtml += `
                    <div class="mini-stat">
                        <div class="mini-stat-value">${data.stats.total_domains}</div>
                        <div class="mini-stat-label">Unique Domains</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${data.stats.total_visits}</div>
                        <div class="mini-stat-label">Total Visits</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${formatBytes(data.stats.total_usage)}</div>
                        <div class="mini-stat-label">Total Data</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value">${data.stats.active_time}</div>
                        <div class="mini-stat-label">Active Time</div>
                    </div>
                `;
                statsHtml += '</div>';
                
                // Category breakdown
                statsHtml += '<h6 style="color: #58a6ff; margin: 20px 0 10px 0;">Usage by Category</h6>';
                Object.entries(data.stats.categories).forEach(([cat, usage]) => {
                    const pct = (usage / data.stats.total_usage * 100).toFixed(1);
                    statsHtml += `
                        <div class="site-entry">
                            <span class="domain-name">${cat}</span>
                            <span class="visit-count">${formatBytes(usage)} (${pct}%)</span>
                        </div>
                    `;
                });
                
                // Content Types breakdown
                statsHtml += '<h6 style="color: #58a6ff; margin: 20px 0 10px 0;">üìä Content Types</h6>';
                const contentIcons = {
                    'images': 'üñºÔ∏è Images',
                    'videos': 'üé¨ Videos',
                    'streaming': 'üì∫ Streaming',
                    'audio': 'üéµ Audio',
                    'text': 'üìÑ Web Pages',
                    'documents': 'üìÅ Documents',
                    'downloads': '‚¨áÔ∏è Downloads',
                    'other': 'üì¶ Other'
                };
                
                const contentEntries = Object.entries(data.stats.content_types || {})
                    .filter(([_, usage]) => usage > 0)
                    .sort((a, b) => b[1] - a[1]);
                
                if (contentEntries.length > 0) {
                    contentEntries.forEach(([type, usage]) => {
                        const pct = (usage / data.stats.total_usage * 100).toFixed(1);
                        statsHtml += `
                            <div class="site-entry">
                                <span class="domain-name">${contentIcons[type] || type}</span>
                                <span class="visit-count">${formatBytes(usage)} (${pct}%)</span>
                            </div>
                        `;
                    });
                } else {
                    statsHtml += '<p style="color: #6e7681;">No content type data available</p>';
                }
                
                document.getElementById('stats').innerHTML = statsHtml;
                
                document.getElementById('detailsModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading details:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('detailsModal')) {
                closeModal();
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch('/data');
                const data = await response.json();
                
                document.getElementById('wan-total').innerText = formatBytes(data.stats.wan);
                document.getElementById('clients-net').innerText = formatBytes(data.stats.clients_net);
                document.getElementById('clients-loc').innerText = formatBytes(data.stats.clients_loc);
                document.getElementById('host-total').innerText = formatBytes(data.stats.host_usage);
                document.getElementById('session-time').innerText = data.stats.runtime;

                const now = Date.now();
                if (now > nextSortTime || cachedOrder.length === 0) {
                    data.devices.sort((a, b) => {
                        if (a.is_host) return -1;
                        if (b.is_host) return 1;
                        return b.speed - a.speed;
                    });
                    cachedOrder = data.devices.map(d => d.mac);
                    nextSortTime = now + SORT_INTERVAL_MS;
                } else {
                    data.devices.sort((a, b) => {
                        let idxA = cachedOrder.indexOf(a.mac);
                        let idxB = cachedOrder.indexOf(b.mac);
                        if (idxA === -1) idxA = 9999;
                        if (idxB === -1) idxB = 9999;
                        return idxA - idxB;
                    });
                }

                document.getElementById('sort-countdown').innerText = formatTimeLeft(nextSortTime - now);

                const container = document.getElementById('devices-container');
                container.innerHTML = ''; 

                data.devices.forEach(dev => {
                    const total = dev.total_net + dev.total_loc;
                    let appsHtml = '';
                    
                    dev.apps.slice(0, 5).forEach(app => {
                        const pct = total > 0 ? (app.usage / total * 100).toFixed(1) : 0;
                        appsHtml += `
                            <div class="app-row">
                                <span>${app.name}</span>
                                <span class="usage-text">${formatBytes(app.usage)} <span style="color:#6e7681">(${pct}%)</span></span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: ${pct}%"></div>
                            </div>
                        `;
                    });
                    
                    // ÿπÿ±ÿ∂ ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
                    let contentHtml = '<div style="margin-top: 15px;"><strong style="color: #8b949e; font-size: 0.9rem;">üìä Content Types:</strong></div>';
                    
                    const contentIcons = {
                        'images': 'üñºÔ∏è',
                        'videos': 'üé¨',
                        'streaming': 'üì∫',
                        'audio': 'üéµ',
                        'text': 'üìÑ',
                        'documents': 'üìÅ',
                        'downloads': '‚¨áÔ∏è',
                        'other': 'üì¶'
                    };
                    
                    const contentLabels = {
                        'images': 'Images',
                        'videos': 'Videos',
                        'streaming': 'Streaming',
                        'audio': 'Audio',
                        'text': 'Web Pages',
                        'documents': 'Documents',
                        'downloads': 'Downloads',
                        'other': 'Other'
                    };
                    
                    // ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ
                    const contentArray = Object.entries(dev.content_types || {})
                        .filter(([_, usage]) => usage > 0)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 4);
                    
                    if (contentArray.length > 0) {
                        contentArray.forEach(([type, usage]) => {
                            const pct = total > 0 ? (usage / total * 100).toFixed(1) : 0;
                            contentHtml += `
                                <div class="content-type-box ct-${type}">
                                    <span>
                                        <span class="content-icon">${contentIcons[type] || 'üì¶'}</span>
                                        ${contentLabels[type] || type}
                                    </span>
                                    <span style="color: #8b949e; font-size: 0.85rem;">
                                        ${formatBytes(usage)} (${pct}%)
                                    </span>
                                </div>
                            `;
                        });
                    } else {
                        contentHtml += '<p style="color: #6e7681; font-size: 0.85rem; margin: 5px 0;">No data yet...</p>';
                    }

                    const speedClass = getSpeedClass(dev.speed);
                    const ipAlert = dev.ip_log ? `<div class="ip-changed"><i class="fas fa-exclamation-triangle"></i> ${dev.ip_log}</div>` : '';

                    const cardHtml = `
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <span class="device-name">${dev.name}</span>
                                            <span class="vendor-badge">${dev.vendor}</span>
                                        </div>
                                        <div class="${speedClass} speed-indicator">
                                            <i class="fas fa-tachometer-alt"></i> ${formatSpeed(dev.speed)}
                                        </div>
                                    </div>
                                    
                                    <div class="device-meta">
                                        <div><i class="fas fa-network-wired"></i> ${dev.ip} ‚Ä¢ <span style="color: #6e7681">${dev.mac}</span></div>
                                        <div><i class="fas fa-globe"></i> Net: ${formatBytes(dev.total_net)} | <i class="fas fa-home"></i> Loc: ${formatBytes(dev.total_loc)}</div>
                                        <div><i class="fas fa-chart-line"></i> Domains: ${dev.unique_domains} | Visits: ${dev.total_visits}</div>
                                        ${ipAlert}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <button class="btn-details" onclick="showDeviceDetails('${dev.mac}')">
                                            <i class="fas fa-info-circle"></i> View Details
                                        </button>
                                    </div>
                                    
                                    <hr class="border-secondary">
                                    <div class="mt-2">
                                        ${appsHtml}
                                        ${contentHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHtml;
                });

                document.getElementById('connection-status').innerText = '‚óè Live';
                document.getElementById('connection-status').className = 'text-success';

            } catch (error) {
                document.getElementById('connection-status').innerText = 'üî¥ Disconnected';
                document.getElementById('connection-status').className = 'text-danger';
            }
        }
        
        setInterval(updateDashboard, 1000);
        updateDashboard();
    </script>
</body>
</html>
